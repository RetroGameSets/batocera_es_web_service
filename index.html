<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Batocera Web Interface</title>
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" crossorigin="anonymous">
<!-- Font Awesome (v4) for 'fa' icon classes -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous" />
<!-- Custom styles -->
<link rel="stylesheet" href="style.css" />
<!-- jQuery and Bootstrap JS (needed for modals/buttons) -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</head>

<body>
<!-- See REST Api list on https://github.com/batocera-linux/batocera-emulationstation/blob/master/es-app/src/services/HttpServerThread.cpp#L25 -->
<script type='text/javascript'>

// ------------------ Helpers ------------------
const qs = (sel, root = document) => root.querySelector(sel);
const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));
const norm = (s) => (s || '').toString().toLowerCase();
const isFavGame = (g) => String(g?.favorite) === 'true';
const hasCheevos = (g) => g && g.cheevosHash && parseInt(g.cheevosHash, 10) !== 0;
const playCount = (g) => (g && g.playcount ? parseInt(g.playcount, 10) || 0 : 0);
const getYear = (g) => { const m = String(g?.releasedate || '').match(/^\d{4}/); return m ? parseInt(m[0], 10) : null; };
const forceVisibleGames = (arr) => (Array.isArray(arr) ? arr.map(g => ({ ...g, hidden: 'false' })) : []);
const debounce = (fn, wait = 150) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; };

const recalcTopPads = () => {
    const top = qs('.navbar.fixed-top');
    const tb = qs('.toolbar');
    const bottom = qs('.navbar.fixed-bottom');
    const topH = top ? top.getBoundingClientRect().height : 56;
    const tbH = tb ? tb.getBoundingClientRect().height : 0;
    const bottomH = bottom ? bottom.getBoundingClientRect().height : 56;
    document.documentElement.style.setProperty('--toolbar-top', `${Math.ceil(topH)}px`);
    document.body.classList.add('padded');
    document.body.style.setProperty('--total-top-pad', `${Math.ceil(topH + tbH + 8)}px`);
    document.body.style.setProperty('--bottom-pad', `${Math.ceil(bottomH + 12)}px`);
};
window.addEventListener('resize', () => requestAnimationFrame(recalcTopPads));

// ------------------ State: Systems ------------------
const LS_SYS_KEY = 'sys-settings-v1';
const sysState = {
    systems: [],
    filter: '',
    sort: 'pinned-recent-alpha',
    zoom: 1,
    pinned: new Set(),
    recent: [],
    selected: '',
    running: '',
    counts: new Map(),
    scrollbars: 'hide',
};
const saveSys = () => {
    const data = {
        filter: sysState.filter, sort: sysState.sort, zoom: sysState.zoom,
        pinned: [...sysState.pinned], recent: sysState.recent.slice(0,12),
        scrollbars: sysState.scrollbars
    };
    localStorage.setItem(LS_SYS_KEY, JSON.stringify(data));
};
const loadSys = () => {
    try {
        const raw = localStorage.getItem(LS_SYS_KEY); if (!raw) return;
        const d = JSON.parse(raw);
        sysState.filter = d.filter || '';
        sysState.sort = d.sort || 'pinned-recent-alpha';
        sysState.zoom = Math.min(1.8, Math.max(0.6, d.zoom || 1));
        sysState.pinned = new Set(d.pinned || []);
        sysState.recent = Array.isArray(d.recent) ? d.recent : [];
        sysState.scrollbars = d.scrollbars || 'hide';
    } catch {}
};
loadSys();
const applyScrollbarMode = () => {
    document.documentElement.classList.remove('hide-scrollbars','thin-scrollbars');
    if (sysState.scrollbars === 'hide') document.documentElement.classList.add('hide-scrollbars');
    else if (sysState.scrollbars === 'thin') document.documentElement.classList.add('thin-scrollbars');
};

// ------------------ State: Games ------------------
const LS_GAMES_KEY = 'games-settings-v4';
const gamesState = {
    query: '',
    sort: 'name-asc',
    favOnly: false,
    unplayedOnly: false,
    cheevosOnly: false,
    pageSize: 100,
    page: 1,
    gamesAll: [],
    view: 'grid',
    uiReady: false,
};
const saveGames = () => {
    const d = { query:gamesState.query, sort:gamesState.sort, favOnly:gamesState.favOnly,
        unplayedOnly:gamesState.unplayedOnly, cheevosOnly:gamesState.cheevosOnly,
        pageSize:gamesState.pageSize, page:gamesState.page, view:gamesState.view };
    localStorage.setItem(LS_GAMES_KEY, JSON.stringify(d));
};
const loadGamesPrefs = () => {
    try {
        const raw = localStorage.getItem(LS_GAMES_KEY); if (!raw) return;
        const d = JSON.parse(raw);
        gamesState.query = d.query || '';
        gamesState.sort = d.sort || 'name-asc';
        gamesState.favOnly = !!d.favOnly;
        gamesState.unplayedOnly = !!d.unplayedOnly;
        gamesState.cheevosOnly = !!d.cheevosOnly;
        gamesState.pageSize = parseInt(d.pageSize || 100, 10);
        gamesState.page = parseInt(d.page || 1, 10);
        gamesState.view = d.view === 'list' ? 'list' : 'grid';
    } catch {}
};
loadGamesPrefs();

// √âtat de chargement minimal
let currentSystemName = null;

// ------------------ Toolbar (Games) ------------------
const addToolbar = () => {
    if (gamesState.uiReady) return;
    const bar = document.createElement('div');
    // Start hidden by default; user can toggle from navbar
    bar.className = 'toolbar hidden';
    bar.innerHTML = `
        <div class="tools">
            <span class="label">Recherche</span>
            <input id="search" class="form-control form-control-sm input" type="search" placeholder="Nom/genre‚Ä¶" aria-label="Recherche jeux">

            <span class="label">Tri</span>
            <select id="sort" class="custom-select custom-select-sm" title="Tri">
                <option value="name-asc">Nom A‚ÜíZ</option>
                <option value="name-desc">Nom Z‚ÜíA</option>
                <option value="year-desc">Ann√©e ‚Üì</option>
                <option value="year-asc">Ann√©e ‚Üë</option>
                <option value="playcount-desc">Sessions ‚Üì</option>
                <option value="playcount-asc">Sessions ‚Üë</option>
                <option value="favorite-first">Favoris d'abord</option>
            </select>

            <div class="btn-group btn-group-sm ml-1" role="group" aria-label="Affichage">
                <button id="view-grid" type="button" class="btn btn-outline-secondary" title="Affichage grille"><i class="fa fa-th" aria-hidden="true"></i></button>
                <button id="view-list" type="button" class="btn btn-outline-secondary" title="Affichage liste"><i class="fa fa-list" aria-hidden="true"></i></button>
            </div>

            <div class="ck-group">
                <label><input type="checkbox" id="fav"> Favoris</label>
                <label><input type="checkbox" id="unplayed"> Jamais jou√©s</label>
                <label><input type="checkbox" id="cheevos"> Succ√®s</label>
            </div>

            <span class="spacer"></span>
            <button id="reset" class="btn btn-sm btn-outline-secondary btn-min" title="R√©initialiser filtres/tri/page">R√©init.</button>
            <button id="export" class="btn btn-sm btn-outline-secondary btn-min" title="Exporter (JSON)">Exporter</button>
        </div>
    `;
    const row = document.querySelector('body > div.row') || document.querySelector('.main-content');
    if (row && row.parentElement) row.parentElement.insertBefore(bar, row);
    else document.body.insertBefore(bar, document.body.firstChild);

    const search = qs('#search', bar);
    const sort = qs('#sort', bar);
    const fav = qs('#fav', bar);
    const unplayed = qs('#unplayed', bar);
    const cheevos = qs('#cheevos', bar);
    const pageSize = null; // moved to bottom pager
    const randomBtn = null; // moved to top navbar
    const exportBtn = qs('#export', bar);
    const resetBtn = qs('#reset', bar);
    const viewGridBtn = qs('#view-grid', bar);
    const viewListBtn = qs('#view-list', bar);

    search.value = gamesState.query;
    sort.value = gamesState.sort;
    fav.checked = gamesState.favOnly;
    unplayed.checked = gamesState.unplayedOnly;
    cheevos.checked = gamesState.cheevosOnly;
    // view mode
    const applyViewButtons = ()=>{
        if (gamesState.view === 'list') {
            viewListBtn && viewListBtn.classList.add('active');
            viewGridBtn && viewGridBtn.classList.remove('active');
        } else {
            viewGridBtn && viewGridBtn.classList.add('active');
            viewListBtn && viewListBtn.classList.remove('active');
        }
    };
    applyViewButtons();
    // page size moved to bottom pager

    search.addEventListener('input', (e) => { gamesState.query = e.target.value; gamesState.page = 1; saveGames(); renderFiltered(); });
    sort.addEventListener('change', (e) => { gamesState.sort = e.target.value; gamesState.page = 1; saveGames(); renderFiltered(); });
    fav.addEventListener('change', (e) => { gamesState.favOnly = e.target.checked; gamesState.page = 1; saveGames(); renderFiltered(); });
    unplayed.addEventListener('change', (e) => { gamesState.unplayedOnly = e.target.checked; gamesState.page = 1; saveGames(); renderFiltered(); });
    cheevos.addEventListener('change', (e) => { gamesState.cheevosOnly = e.target.checked; gamesState.page = 1; saveGames(); renderFiltered(); });
    // page size change handler moved to bottom pager

    // view mode toggle
    if (viewGridBtn) viewGridBtn.addEventListener('click', ()=>{ gamesState.view='grid'; saveGames(); applyViewButtons(); renderFiltered(); });
    if (viewListBtn) viewListBtn.addEventListener('click', ()=>{ gamesState.view='list'; saveGames(); applyViewButtons(); renderFiltered(); });

    resetBtn.addEventListener('click', () => {
        gamesState.query = '';
        gamesState.sort = 'name-asc';
        gamesState.favOnly = false;
        gamesState.unplayedOnly = false;
        gamesState.cheevosOnly = false;
        gamesState.pageSize = 100;
        gamesState.page = 1;
        search.value = '';
        sort.value = 'name-asc';
        fav.checked = unplayed.checked = cheevos.checked = false;
        // bottom select if present
        const ps = document.getElementById('bottom-page-size');
        if (ps) ps.value = '100';
        saveGames();
        // Re-render using full gamesAll list with cleared filters
        renderFiltered();
    });

    // random button moved to top navbar
    exportBtn.addEventListener('click', () => {
        const arr = getFilteredSorted();
        const minimal = arr.map(g => ({ name:g.name, path:g.path, genre:g.genre||null, year:getYear(g), playcount:playCount(g), favorite:isFavGame(g), cheevos:hasCheevos(g) }));
        const text = JSON.stringify(minimal, null, 2);
        try { 
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text);
                alert(`Liste export√©e (${minimal.length} √©l√©ments) dans le presse-papiers.`);
            }
        }
        catch { alert(`Liste export√©e (${minimal.length} √©l√©ments).`); }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === '/' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) { e.preventDefault(); search.focus(); }
        if (e.key.toLowerCase() === 'r' && !e.ctrlKey && !e.metaKey) { e.preventDefault(); reloadGamelists(); }
        if (e.key === 'ArrowRight') pagerGo(gamesState.page + 1);
        if (e.key === 'ArrowLeft') pagerGo(gamesState.page - 1);
    });

    gamesState.uiReady = true;
    requestAnimationFrame(recalcTopPads);
};

const updateSummary = (pageCount, total) => {
    const s = qs('#bottom-summary'); if (!s) return;
    const start = total ? ((gamesState.page - 1) * gamesState.pageSize + 1) : 0;
    const end = Math.min(gamesState.page * gamesState.pageSize, total);
    s.textContent = `${total ? `${start}-${end}` : '0-0'}`;
};

const renderPager = (filteredCount) => {
    const pager = qs('#bottom-pager'); if (!pager) return;
    const pages = gamesState.pageSize >= 9999 ? 1 : Math.max(1, Math.ceil(filteredCount / gamesState.pageSize));
    gamesState.page = Math.min(Math.max(1, gamesState.page), pages);
    const btn = (label, page, disabled = false) =>
        `<button class="btn btn-sm btn-outline-info${disabled ? ' disabled' : ''}" data-page="${page}" title="${label}">${label}</button>`;
    pager.innerHTML = `${btn('¬´',1,gamesState.page===1)}${btn('‚Äπ',gamesState.page-1,gamesState.page===1)}<span class="text-light">Page ${gamesState.page}/${pages}</span>${btn('‚Ä∫',gamesState.page+1,gamesState.page===pages)}${btn('¬ª',pages,gamesState.page===pages)}`;
    qsa('button[data-page]', pager).forEach(b => b.addEventListener('click', () => pagerGo(parseInt(b.getAttribute('data-page'),10))));
};
const pagerGo = (p) => {
    const filtered = getFilteredSorted();
    const pages = gamesState.pageSize >= 9999 ? 1 : Math.max(1, Math.ceil(filtered.length / gamesState.pageSize));
    const clamped = Math.min(Math.max(1, p), pages);
    if (clamped !== gamesState.page) { gamesState.page = clamped; saveGames(); renderFiltered(); }
};

const getFilteredSorted = () => {
    let arr = gamesState.gamesAll.slice();
    arr = arr.filter(g => String(g.hidden) !== 'true');
    const q = norm(gamesState.query);
    if (q) arr = arr.filter(g => norm(g.name).includes(q) || norm(g.genre).includes(q));
    if (gamesState.favOnly) arr = arr.filter(isFavGame);
    if (gamesState.unplayedOnly) arr = arr.filter(g => playCount(g) === 0);
    if (gamesState.cheevosOnly) arr = arr.filter(hasCheevos);
    const cmp = {
        'name-asc': (a,b)=> norm(a.name).localeCompare(norm(b.name)),
        'name-desc': (a,b)=> norm(b.name).localeCompare(norm(a.name)),
        'year-desc': (a,b)=> (getYear(b)||-1)-(getYear(a)||-1) || norm(a.name).localeCompare(norm(b.name)),
        'year-asc': (a,b)=> (getYear(a)||99999)-(getYear(b)||99999) || norm(a.name).localeCompare(norm(b.name)),
        'playcount-desc': (a,b)=> playCount(b)-playCount(a) || norm(a.name).localeCompare(norm(b.name)),
        'playcount-asc': (a,b)=> playCount(a)-playCount(b) || norm(a.name).localeCompare(norm(b.name)),
        'favorite-first': (a,b)=> (isFavGame(b)-isFavGame(a)) || norm(a.name).localeCompare(norm(b.name)),
    }[gamesState.sort] || ((a,b)=> norm(a.name).localeCompare(norm(b.name)));
    arr.sort(cmp);
    return arr;
};

// ------------------ Rendu des cartes ------------------
const renderCards = (list) => {
    if (gamesState.view === 'list') { return renderListView(list); }
    const gameList = document.getElementById('gameList');
    if (!gameList) return;
    if (!list || list.length === 0) {
        gameList.innerHTML = '<div class="text-center text-muted" style="padding:24px">Aucun jeu ne correspond aux filtres/recherche.</div>';
        return;
    }
    // conteneur grille
    gameList.innerHTML = '<div class="row" id="gameContainer"></div>';
    const gameContainer = document.getElementById('gameContainer');
    const frag = document.createDocumentFragment();
    list.forEach(g => { frag.appendChild(createGameCardElement(g)); });
    gameContainer.appendChild(frag);
    // marquer favoris
    try {
        const cards = qsa('.card.card-game', gameContainer);
        list.forEach((g,i) => { const c = cards[i]; if (c && isFavGame(g)) c.classList.add('fav'); });
    } catch {}
};

// Rendu liste compact
const renderListView = (list) => {
    const gameList = document.getElementById('gameList');
    if (!gameList) return;
    if (!list || list.length === 0) {
        gameList.innerHTML = '<div class="text-center text-muted" style="padding:16px">Aucun jeu ne correspond aux filtres/recherche.</div>';
        return;
    }
    gameList.innerHTML = '<div class="list-container" id="gameContainer"></div>';
    const gameContainer = document.getElementById('gameContainer');
    const frag = document.createDocumentFragment();
    list.forEach(g => { frag.appendChild(createListItemElement(g)); });
    gameContainer.appendChild(frag);
};

function createListItemElement(game) {
    const row = document.createElement('div');
    row.className = 'list-item';
    const thumb = game.thumbnail || game.image || '';
    const year = getYear(game);
    const genre = (game.genre || '').split(',')[0];
    const chee = hasCheevos(game);
    const fav = isFavGame(game);
    row.innerHTML = `
        <div class="li-thumb">${thumb ? `<img src="${thumb}" alt="" loading="lazy">` : ''}</div>
        <div class="li-main">
            <div class="li-title" title="${escapeHtml(game.name||'')}">${escapeHtml(game.name||'')}</div>
            <div class="li-meta">${year ? year : ''}${year && genre ? ' ¬∑ ' : ''}${genre ? escapeHtml(genre) : ''}${(fav||chee) ? ' ¬∑ ' : ''}${fav ? '‚òÖ' : ''}${fav && chee ? ' ' : ''}${chee ? 'üèÜ' : ''}</div>
        </div>
        <div class="li-actions">
            <button class="btn btn-sm btn-primary" title="Jouer">Play</button>
            <button class="btn btn-sm btn-info" title="Infos" data-toggle="modal" data-target="#detailModal"
                data-name="${escapeHtml(game.name||'')}"
                data-desc="${escapeHtml(game.desc||'')}"
                data-thumb="${game.thumbnail||''}"
                data-image="${game.image||''}"
                data-genre="${escapeHtml(game.genre||'')}"
                data-releasedate="${escapeHtml(game.releasedate||'')}"
                data-cheevos="${hasCheevos(game)}"
                data-path="${escapeHtml(String(game.path||''))}"
                data-playcount="${playCount(game)}"
                data-players="${escapeHtml(String(game.players||''))}"
                data-developer="${escapeHtml(game.developer||'')}"
                data-publisher="${escapeHtml(game.publisher||'')}"
                data-rating="${escapeHtml(String(game.rating||''))}"
                data-lastplayed="${escapeHtml(String(game.lastplayed||''))}"
                data-favorite="${isFavGame(game)}"
            >Infos</button>
        </div>
    `;
    const playBtn = row.querySelector('.li-actions .btn.btn-primary');
    playBtn && playBtn.addEventListener('click', ()=> launchGame(String(game.path||'').replace(/'/g,'')));
    const infoBtn = row.querySelector('.li-actions .btn.btn-info');
    infoBtn && infoBtn.addEventListener('click', detailFill);
    return row;
}

// ------------------ Rendu filtr√© + pagination ------------------
const renderFiltered = () => {
    const filtered = getFilteredSorted();
    const total = filtered.length;

    const pages = gamesState.pageSize >= 9999 ? 1 : Math.max(1, Math.ceil(Math.max(1, total) / gamesState.pageSize));
    if (gamesState.page < 1) gamesState.page = 1;
    if (gamesState.page > pages) gamesState.page = pages;

    let pageItems = filtered;
    if (gamesState.pageSize < 9999) {
        const start = (gamesState.page - 1) * gamesState.pageSize;
        pageItems = filtered.slice(start, start + gamesState.pageSize);
    }
    const safe = forceVisibleGames(pageItems);
    renderCards(safe);

    updateSummary(pageItems.length, total);
    renderPager(total);
    requestAnimationFrame(recalcTopPads);
};

function reloadGamelists() {
    fetch('/reloadgames');
}

function emuKill() {
    fetch('/emukill');
}

function launchGame(game) {
    fetch('/launch', {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: game
    });
}

function escapeHtml(unsafe) {
    return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function escapeRom(unsafe) {
    return unsafe
    .replace(/'/g, "");
}

function formatEsDate(val) {
    if (!val) return '';
    const s = String(val);
    const y = s.slice(0,4), m = s.slice(4,6), d = s.slice(6,8);
    if (/^\d{4}$/.test(y) && /^\d{2}$/.test(m) && /^\d{2}$/.test(d)) return `${y}-${m}-${d}`;
    return '';
}

function setDetailModal(game) {
    const mtitle = document.getElementById('detailModalLabel');
    const marg = document.getElementById('detailModalBody');
    const pic = document.getElementById('detailModalImg');
    const facts = document.getElementById('detailFacts');
    if (mtitle) mtitle.textContent = game?.name || '';
    if (marg) marg.innerHTML = game?.desc || '';
    if (pic) pic.src = game?.image || game?.thumbnail || '';
    if (facts) {
        const rows = [];
        const year = getYear(game);
        const genre = (game?.genre || '').trim();
        const ra = hasCheevos(game);
        const pth = game?.path || '';
        const pc = playCount(game);
        const last = formatEsDate(game?.lastplayed || '');
        const players = (game?.players || '').toString();
        const dev = game?.developer || '';
        const pub = game?.publisher || '';
        const fav = isFavGame(game);
        const rating = game?.rating !== undefined && game?.rating !== null && game?.rating !== '' ? Number(game.rating) : null;
        if (year) rows.push({ label: 'Ann√©e', value: String(year) });
        if (genre) rows.push({ label: 'Genre', value: escapeHtml(genre) });
    // rows.push({ label: 'Succ√®s (RetroAchievements)', value: ra ? '<span class="ra-badge"><i class="fa fa-trophy ra-icon" aria-hidden="true"></i><span class="ra-text">Oui</span></span>' : 'Non' });
        if (pth) rows.push({ label: 'Chemin', value: `<code class="path">${escapeHtml(pth)}</code>` });
        rows.push({ label: 'Sessions', value: pc > 0 ? `${pc} fois` : 'Jamais' });
        if (last) rows.push({ label: 'Derni√®re session', value: last });
        if (players) rows.push({ label: 'Joueurs', value: escapeHtml(players) });
        if (dev) rows.push({ label: 'D√©veloppeur', value: escapeHtml(dev) });
        if (pub) rows.push({ label: '√âditeur', value: escapeHtml(pub) });
        rows.push({ label: 'Favori', value: fav ? '<i class="fa fa-star" aria-hidden="true"></i> Oui' : 'Non' });
        if (rating !== null && !isNaN(rating)) rows.push({ label: 'Note', value: `${Math.round(Math.min(Math.max(rating, 0), 1)*100)}%` });
        facts.innerHTML = rows.map(r => `
            <div class="df-row">
                <div class="df-label">${r.label}</div>
                <div class="df-value">${r.value}</div>
            </div>
        `).join('');
    }
    const kb = document.getElementById('detailKillBtn');
    if (kb) { kb.style.display = 'none'; kb.onclick = null; }
    const pb = document.getElementById('detailPlayBtn');
    if (pb) {
        const pth = game?.path || '';
        if (pth) {
            pb.style.display = 'inline-block';
            pb.disabled = false;
            pb.onclick = function(){ launchGame(String(pth).replace(/'/g,'')); try { $('#detailModal').modal('hide'); } catch {} };
        } else {
            pb.style.display = 'none';
            pb.onclick = null;
        }
    }
}

function detailFill(ev) {
    try {
        const t = ev?.target || window.event?.target;
        const d = t?.dataset || {};
        const game = {
            name: t?.getAttribute('data-name') || '',
            desc: t?.getAttribute('data-desc') || '',
            thumbnail: t?.getAttribute('data-thumb') || '',
            image: t?.getAttribute('data-image') || '',
            genre: d.genre || '',
            releasedate: d.releasedate || '',
            cheevosHash: d.cheevos === 'true' ? '1' : (d.cheevos || ''),
            path: d.path || '',
            playcount: d.playcount || '',
            players: d.players || '',
            developer: d.developer || '',
            publisher: d.publisher || '',
            rating: d.rating || '',
            lastplayed: d.lastplayed || '',
            favorite: d.favorite || 'false',
        };
        setDetailModal(game);
    } catch { 
        // Fallback au comportement original
        let title = event.target.getAttribute('data-name');
        var mtitle = document.getElementById("detailModalLabel");
        let arg = event.target.getAttribute('data-desc');
        var marg = document.getElementById("detailModalBody");
        let thumb = event.target.getAttribute('data-thumb');
        let img = event.target.getAttribute('data-image');
        var pic = document.getElementById("detailModalImg");
        mtitle.innerHTML = title;
        marg.innerHTML = arg;
        if (img)
            pic.src = img;
        else if (thumb)
            pic.src = thumb;
        else
            pic.src = "";
    }
}

// Virtual scrolling variables (moved to top)

function showGames(arr) {
    gamesState.gamesAll = Array.isArray(arr) ? arr.slice() : [];
    addToolbar();
    renderFiltered();
}

// (infinite scroll removed)

function createGameCardElement(game) {
    const regex = /^\d\d\d\d/;
    const cardDiv = document.createElement('div');
    cardDiv.className = 'card text-white bg-dark card-game';

    let cardHtml = '';

    // Image handling
    if(game.thumbnail)
        cardHtml += '<img class="card-img-top card-img-150" loading="lazy" src="' + game.thumbnail + '">';
    else if(game.image)
        cardHtml += '<img class="card-img-top card-img-150" loading="lazy" src="' + game.image + '">';

    // Title/Marquee
    if(game.marquee)
        cardHtml += '<img class="card-img card-title-50" loading="lazy" src="' + game.marquee + '">';
    else
        cardHtml += '<div class="card-title text-center">' + game.name +'</div>';

    cardHtml += '<div class="card-text align-items-center">';

    // Genre
    if (game.genre) {
        cardHtml += '<p>' + game.genre +'</p>';
    }

    // Release date
    if (game.releasedate && regex.test(game.releasedate)) {
        cardHtml += '<p>' + game.releasedate.match(regex) +'</p>';
    }

    // Icons
    if (game.cheevosHash && parseInt(game.cheevosHash) != 0) {
        cardHtml += '<i class="fa fa-trophy" style="margin-left:2px; margin-right:2px"></i>';
    }
    if (game.favorite == "true") {
        cardHtml += '<i class="fa fa-star" style="margin-left:2px; margin-right:2px"></i>';
    }

    // Play count
    if (game.playcount && parseInt(game.playcount) > 0) {
        cardHtml += '<p>Played ' + game.playcount + ' time';
        if (parseInt(game.playcount) > 1)
            cardHtml += 's';
        cardHtml += '</p>';
    } else {
        cardHtml += '<p>Never played</p>';
    }

    cardHtml += '</div><div class="card-footer mx-auto">';
    cardHtml += '<input type="button" class="btn btn-primary" onClick="launchGame(\'' + escapeRom(game.path) + '\')" value="Play">';
    cardHtml += '<input type="button" class="btn btn-info" data-toggle="modal" data-target="#detailModal"' +
        ' data-desc="' + escapeHtml(game.desc || '') + '"' +
        ' data-name="' + escapeHtml(game.name || '') + '"' +
        ' data-thumb="' + (game.thumbnail || '') + '"' +
        ' data-image="' + (game.image || '') + '"' +
        ' data-genre="' + escapeHtml(game.genre || '') + '"' +
        ' data-releasedate="' + escapeHtml(game.releasedate || '') + '"' +
        ' data-cheevos="' + (hasCheevos(game)) + '"' +
        ' data-path="' + escapeHtml(String(game.path || '')) + '"' +
        ' data-playcount="' + playCount(game) + '"' +
        ' data-players="' + escapeHtml(String(game.players || '')) + '"' +
        ' data-developer="' + escapeHtml(game.developer || '') + '"' +
        ' data-publisher="' + escapeHtml(game.publisher || '') + '"' +
        ' data-rating="' + escapeHtml(String(game.rating || '')) + '"' +
        ' data-lastplayed="' + escapeHtml(String(game.lastplayed || '')) + '"' +
        ' data-favorite="' + (isFavGame(game)) + '"' +
        ' value="Infos" onClick="detailFill()">';
    cardHtml += '</div>'; // card-footer

    cardDiv.innerHTML = cardHtml;
    return cardDiv;
}

// (infinite scroll removed)

function getOrder(prop) {
    return function(a, b) {
        if (a[prop] > b[prop]) {
            return 1;
        } else if (a[prop] < b[prop]) {
            return -1;
        }
        return 0;
    }
}

function loadGames(name) {
    sysState.selected = name || '';
    if (name) {
        sysState.recent = [name, ...sysState.recent.filter(n => n !== name)].slice(0,24);
        gamesState.page = 1; saveGames(); saveSys();
    }
    currentSystemName = name;
    const gl = document.getElementById('gameList');
    if (gl) gl.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-light" role="status"><span class="sr-only">Loading...</span></div><p class="mt-3">Loading games...</p></div>';

    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            if (currentSystemName === name) {
                var myArr = JSON.parse(this.responseText);
                myArr.sort(getOrder('name'));
                showGames(myArr);
                // Update navbar title with system name and games count
                (function(){
                    const navTitle = document.getElementById('navSystemTitle');
                    if (!navTitle) return;
                    const sys = sysState.systems.find(s => s.name === name);
                    const title = (sys && (sys.fullname || sys.name)) || name || '';
                    const count = Array.isArray(myArr) ? myArr.filter(g => String(g.hidden)!=='true').length : 0;
                    navTitle.textContent = `${title} - ${count} games`;
                })();
            }
        }
    };
    xhr.open('GET', '/systems/' + name + '/games');
    xhr.send();
}

function removeItem(arr, value) {
    var index = arr.indexOf(value);
    if (index > -1) {
        arr.splice(index, 1);
    }
    return arr;
}

// ------------------ Dock syst√®mes ------------------
const clearChildren = (el) => { while (el && el.firstChild) el.removeChild(el.firstChild); };

const buildDockSkeleton = () => {
    const sysContainer = document.getElementById('systemList');
    if (!sysContainer) return;
    clearChildren(sysContainer);
    const wrap = document.createElement('div');
    wrap.id = 'sysbar';
    wrap.innerHTML = `
        <div class="sys-toolbar">
            <input id="sys-filter" type="search" placeholder="Filtrer les syst√®mes‚Ä¶" />
            <button id="sys-picker-open" class="btn btn-sm btn-outline-info" title="Liste des syst√®mes"><i class="fa fa-list" aria-hidden="true"></i><span class="sr-only">Liste des syst√®mes</span></button>
            <div class="spacer"></div>
            <!--<label for="sb-mode" style="margin:0 4px 0 0;"></label>
            <select id="sb-mode" title="Mode barres">
                <option value="auto">Auto</option>
                <option value="hide">Masquer</option>
                <option value="thin">Fines</option>
            </select>-->
            <div class="zoom-group"><button id="sys-zoom-dec" title="Zoom ‚Äì">‚Äì</button><button id="sys-zoom-inc" title="Zoom +">+</button></div>
        </div>
        <div class="sys-clip">
            <div class="sys-strip" id="sys-strip" tabindex="0" aria-label="Syst√®mes"></div>
            <div style="height:1px;width:44px;position:absolute;right:0;bottom:0;"></div>
        </div>
        <button class="sys-arrow left" id="sys-left" title="D√©filer √† gauche">‚Äπ</button>
        <button class="sys-arrow right" id="sys-right" title="D√©filer √† droite">‚Ä∫</button>
    `;
    sysContainer.appendChild(wrap);

    qs('#sys-filter').value = sysState.filter;
    // qs('#sb-mode').value = sysState.scrollbars;
    document.documentElement.style.setProperty('--sys-h', `${Math.round(64 * sysState.zoom)}px`);
    applyScrollbarMode();

    qs('#sys-filter').addEventListener('input', (e)=>{ sysState.filter = e.target.value.trim().toLowerCase(); saveSys(); renderSystemDock(); });
    // qs('#sb-mode').addEventListener('change', (e)=>{ sysState.scrollbars = e.target.value; saveSys(); applyScrollbarMode(); });

    const zoomTo = (z)=>{ sysState.zoom = Math.min(1.8, Math.max(0.6, z)); document.documentElement.style.setProperty('--sys-h', `${Math.round(64 * sysState.zoom)}px`); saveSys(); };
    qs('#sys-zoom-dec').addEventListener('click', ()=> zoomTo(sysState.zoom - 0.1));
    qs('#sys-zoom-inc').addEventListener('click', ()=> zoomTo(sysState.zoom + 0.1));

    const strip = qs('#sys-strip');
    const scrollBy = () => Math.max(240, Math.round(strip.clientWidth * 0.8));
    qs('#sys-left').addEventListener('click', ()=> strip.scrollBy({ left: -scrollBy(), behavior: 'smooth' }));
    qs('#sys-right').addEventListener('click', ()=> strip.scrollBy({ left: scrollBy(), behavior: 'smooth' }));

    strip.addEventListener('wheel', (e) => { const d = (e.deltaY || e.deltaX); if (Math.abs(d) >= Math.abs(e.deltaX)) { e.preventDefault(); strip.scrollLeft += d; } }, { passive:false });

    let drag = null;
    const onDown = (e) => { drag = { x: (e.touches ? e.touches[0].clientX : e.clientX), left: strip.scrollLeft }; strip.classList.add('dragging'); };
    const onMove = (e) => { if (!drag) return; const cx = (e.touches ? e.touches[0].clientX : e.clientX); strip.scrollLeft = drag.left - (cx - drag.x); };
    const onUp = () => { drag = null; strip.classList.remove('dragging'); };
    strip.addEventListener('mousedown', onDown); strip.addEventListener('mousemove', onMove); strip.addEventListener('mouseleave', onUp); strip.addEventListener('mouseup', onUp);
    strip.addEventListener('touchstart', onDown, { passive:true }); strip.addEventListener('touchmove', onMove, { passive:true }); strip.addEventListener('touchend', onUp);

    // Open systems picker modal from toolbar button
    const sysPickerBtn = qs('#sys-picker-open', wrap);
    if (sysPickerBtn) sysPickerBtn.addEventListener('click', ()=> { try { $('#systemsModal').modal('show'); } catch(e) {} });

    document.addEventListener('click', () => closeCtx());
    document.addEventListener('contextmenu', (e)=>{ if (!e.target.closest('.sys-item')) closeCtx(); });
};

const closeCtx = () => { qsa('.ctx').forEach(el => el.remove()); };

const renderSystemDock = (keepScroll = false) => {
    const strip = qs('#sys-strip'); if (!strip) return;
    const prevScroll = strip.scrollLeft;
    while (strip.firstChild) strip.removeChild(strip.firstChild);

    let list = sysState.systems.filter(s => String(s.visible) === 'true');
    const filt = (sysState.filter || '').trim().toLowerCase();
    if (filt) list = list.filter(s => (s.fullname||s.name||'').toLowerCase().includes(filt));

    // Keep original order; no sorting applied

    // Keep original order (no sorting)

    for (const s of list) {
        const item = document.createElement('div');
        item.className = 'sys-item';
        item.dataset.name = s.name;
        item.title = s.fullname || s.name || '';
        if (sysState.selected === s.name) item.classList.add('active');
        if (sysState.running === s.name) item.classList.add('running');

        if (s.logo) { const img = document.createElement('img'); img.loading='lazy'; img.src=s.logo; item.appendChild(img); }
        else { const fb = document.createElement('div'); fb.className='fallback'; fb.textContent=s.fullname||s.name; item.appendChild(fb); }

        if (sysState.pinned.has(s.name)) { const star = document.createElement('span'); star.className='pin'; star.textContent='‚òÖ'; item.appendChild(star); }

        const countEl = document.createElement('span');
        countEl.className='count'; countEl.textContent='‚Ä¶'; countEl.style.visibility='hidden'; item.appendChild(countEl);
        item.addEventListener('mouseenter', async ()=> {
            if (countEl.dataset.done) return;
            try {
                const res = await fetch(`/systems/${s.name}/games`);
                const arr = await res.json();
                const nb = (arr || []).filter(g => String(g.hidden) !== 'true').length;
                countEl.textContent = `${nb}`;
            } catch { countEl.textContent = '0'; }
            countEl.style.visibility='visible';
            countEl.dataset.done='1';
        });

        item.addEventListener('click', ()=> {
            sysState.selected=s.name;
            sysState.recent = [s.name, ...sysState.recent.filter(n=>n!==s.name)].slice(0,24);
            gamesState.page = 1; saveGames(); saveSys();
            loadGames(s.name);
            renderSystemDock(true);
        });

        item.addEventListener('auxclick', (e)=>{ if (e.button===1){ e.preventDefault(); (async ()=> {
            try {
                const res = await fetch(`/systems/${s.name}/games`);
                const arr = await res.json();
                const pool = (arr || []).filter(g => String(g.hidden) !== 'true');
                if (!pool.length) return;
                const g = pool[Math.floor(Math.random() * pool.length)];
                launchGame(String(g.path || '').replace(/'/g,''));
            } catch {}
        })(); }});

        // item.addEventListener('contextmenu', (e)=> {
        //     e.preventDefault(); closeCtx();
        //     const m = document.createElement('div');
        //     m.className='ctx';
        //     m.style.cssText = `position:fixed;left:${e.clientX}px;top:${e.clientY}px;background:#2d3748;border:1px solid #4a5568;border-radius:6px;padding:4px 0;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.4);`;
        //     m.innerHTML = `
        //         <button style="display:block;width:100%;text-align:left;padding:6px 12px;border:none;background:none;color:#e2e8f0;cursor:pointer;font-size:14px;" data-act="open">Ouvrir</button>
        //         <button style="display:block;width:100%;text-align:left;padding:6px 12px;border:none;background:none;color:#e2e8f0;cursor:pointer;font-size:14px;" data-act="random">Lancer un jeu al√©atoire</button>
        //         <button style="display:block;width:100%;text-align:left;padding:6px 12px;border:none;background:none;color:#e2e8f0;cursor:pointer;font-size:14px;" data-act="reload">Recharger la gamelist</button>
        //         <button style="display:block;width:100%;text-align:left;padding:6px 12px;border:none;background:none;color:#e2e8f0;cursor:pointer;font-size:14px;" data-act="pin">${sysState.pinned.has(s.name)?'Retirer des favoris':'√âpingler en favoris'}</button>
        //     `;
        //     document.body.appendChild(m);
        //     const doAct = (act) => {
        //         switch(act){
        //             case 'open':
        //                 loadGames(s.name);
        //                 sysState.selected=s.name;
        //                 sysState.recent = [s.name, ...sysState.recent.filter(n=>n!==s.name)].slice(0,24);
        //                 gamesState.page = 1; saveGames(); saveSys();
        //                 renderSystemDock(true);
        //                 break;
        //             case 'random':
        //                 (async ()=> {
        //                     try {
        //                         const res = await fetch(`/systems/${s.name}/games`);
        //                         const arr = await res.json();
        //                         const pool = (arr || []).filter(g => String(g.hidden) !== 'true');
        //                         if (!pool.length) return;
        //                         const g = pool[Math.floor(Math.random() * pool.length)];
        //                         launchGame(String(g.path || '').replace(/'/g,''));
        //                     } catch {}
        //                 })();
        //                 break;
        //             case 'reload': fetch('/reloadgames'); break;
        //             case 'pin':
        //                 if (sysState.pinned.has(s.name)) sysState.pinned.delete(s.name);
        //                 else sysState.pinned.add(s.name);
        //                 saveSys(); renderSystemDock();
        //                 break;
        //         }
        //         closeCtx();
        //     };
        //     qsa('button', m).forEach(b => b.addEventListener('click', ()=> doAct(b.dataset.act)));
        //     setTimeout(() => { qsa('button', m).forEach(b => b.addEventListener('mouseenter', ()=> b.style.background='#4a5568')); qsa('button', m).forEach(b => b.addEventListener('mouseleave', ()=> b.style.background='none')); }, 0);
        // });

        strip.appendChild(item);
    }

    if (keepScroll) strip.scrollLeft = prevScroll;
};

const observeCurrentSystem = () => {
    const jumbo = document.getElementById('jumbo'); if (!jumbo) return;
    const mo = new MutationObserver(() => {
        const sysEl = document.getElementById('sysName');
        const txt = sysEl?.textContent?.trim();
        if (txt) { sysState.running = txt; renderSystemDock(true); }
    });
    mo.observe(jumbo, { childList:true, subtree:true });
};

function showSystems(arr) {
    sysState.systems = Array.isArray(arr) ? arr.slice() : [];
    buildDockSkeleton();
    renderSystemDock();
    recalcTopPads();
}

function describe(d) {
    var out = "";

    if (d.msg) {
        if (d.msg == "NO GAME RUNNING") {
            out += '<div class="gameName" id="gameName">No game running</div>';
            return (out);
        }
        if (d.msg == "ERROR") {
            out += '<div class="gameName" id="gameName">Notification service unreachable</div>';
            return (out);
        }
    }
    out += '<div class="row mx-auto">';
    if (d.image) {
        out += '<div class="col-4 float-right imgCont"><img src="' + d.image + '" class="imgArt" id="imgArt" width="64"></div>';
    } else if (d.thumbnail) {
        out += '<div class="col-4 float-right imgCont"><img src="' + d.thumbnail + '" class="imgArt" id="imgArt" width="64"></div>';
    }
    out += '<div class="col-8 sysCont">';
    if (d.systemName) {
        var url = "/systems/" + d.systemName + "/logo";
        fetch(url).then(response => response.blob())
            .then((blob) => {
                const imgE = document.createElement('img');
                const imgUrl = URL.createObjectURL(blob);
                imgE.src = imgUrl;
                imgE.style.height = "24pt";
                const container = document.getElementById("sysName");
                if (container) {
                    container.innerHTML='';
                    container.appendChild(imgE);
                }
            });
        out += '<div class="row no-gutters"><div class="col-12 sysName" id="sysName" title="">' + d.systemName +'</div></div>';
    }
    if (d.name) {
        out += '<div class="row no-gutters"><div class="col-12 gameName" id="gameName" title="">' + d.name +'</div></div>';
    }
    out += '</div></div>';
    return (out);
}

var PREVDATA = null;

// ------------------ Boot ------------------
const ready = () => {
    observeCurrentSystem();
    applyScrollbarMode();
    recalcTopPads();

    setTimeout(() => {
        const hasCards = !!qs('#gameList .card.card-game');
        if (!hasCards) qs('.sys-item')?.click();
    }, 600);
};

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ready);
else ready();

$(document).ready(function() {
    fetch('/systems')
    .then(response => response.json())
    .then(data => {
        showSystems(data);
    });

    var latestOutput = document.getElementById("jumbo");
    // Construct the WebSocket URL based on the current location of the web page
    var wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    var wsHost = location.host;
    wsHost = wsHost.split(':')[0]+":8080"
    var wsUrl = wsProtocol + '//' + wsHost + '/';
    var ws = new WebSocket(wsUrl);
    ws.onmessage = function(event) {
        var d = event.data;
        if (PREVDATA != d) {
            var dd = JSON.parse(d);
            latestOutput.innerHTML = describe(dd);
            PREVDATA = d;
        }
    };
    ws.onclose = function() {
        var message = { "msg": "ERROR" };
        latestOutput.innerHTML = describe(message);
    };

    // Top Random button (in hamburger menu)
    var randTop = document.getElementById('bwe-random-top') || document.getElementById('random-top');
    if (randTop) {
        randTop.addEventListener('click', function(){
            const arr = getFilteredSorted();
            if (!arr.length) return;
            const g = arr[Math.floor(Math.random() * arr.length)];
            launchGame(String(g.path || '').replace(/'/g,''));
        });
    }

    // Bottom pager: page size control
    var ps = document.getElementById('bottom-page-size');
    if (ps) {
        ps.value = String(gamesState.pageSize);
        ps.addEventListener('change', function(e){
            gamesState.pageSize = parseInt(e.target.value,10);
            gamesState.page = 1; saveGames(); renderFiltered();
        });
    }

    // Click on current section opens detail modal if a game is running
    var jumbo = document.getElementById('jumbo');
    if (jumbo) {
        jumbo.addEventListener('click', function(){
            try {
                if (!PREVDATA) return;
                var dd = JSON.parse(PREVDATA);
                if (dd && dd.name) {
                    const game = {
                        name: dd.name || '',
                        desc: dd.desc || '',
                        image: dd.image || '',
                        thumbnail: dd.thumbnail || '',
                        genre: dd.genre || '',
                        releasedate: dd.releasedate || '',
                        cheevosHash: dd.cheevosHash || '',
                        path: dd.path || '',
                        playcount: dd.playcount || '',
                        players: dd.players || '',
                        developer: dd.developer || '',
                        publisher: dd.publisher || '',
                        rating: dd.rating || '',
                        lastplayed: dd.lastplayed || '',
                        favorite: dd.favorite || 'false',
                    };
                    setDetailModal(game);
                    // Show Kill button and wire it when a game is running
                    var killBtn = document.getElementById('detailKillBtn');
                    if (killBtn) {
                        killBtn.style.display = 'inline-block';
                        killBtn.onclick = function(){ emuKill(); $('#detailModal').modal('hide'); };
                    }
                    $('#detailModal').modal('show');
                }
            } catch {}
        });
    }
    // Ensure Current button reliably toggles the current section
    var showNotifsBtn = document.getElementById('showNotifs');
    var jumboCollapse = document.getElementById('jumbo');
    if (showNotifsBtn && jumboCollapse) {
        showNotifsBtn.addEventListener('click', function(){
            // Use Bootstrap collapse when available; fallback to toggling class
            try { $('#jumbo').collapse('toggle'); } catch {}
            // Fallback: if state didn't change after a tick, toggle class manually
            setTimeout(function(){
                if (!jumboCollapse.classList.contains('collapsing')) {
                    jumboCollapse.classList.toggle('show');
                }
                requestAnimationFrame(recalcTopPads);
            }, 50);
        });
        // Recalculate paddings when the collapse changes height
        try {
            $('#jumbo').on('shown.bs.collapse hidden.bs.collapse', function(){ requestAnimationFrame(recalcTopPads); });
        } catch {}
    }

    // Toggle top toolbar visibility (accordion-like)
    var tgl = document.getElementById('toggleToolbar');
    if (tgl) {
        tgl.addEventListener('click', function(){
            const tb = document.querySelector('.toolbar');
            if (!tb) return;
            tb.classList.toggle('hidden');
            requestAnimationFrame(recalcTopPads);
        });
    }

    // Systems modal: populate and interactions
    $('#systemsModal').on('shown.bs.modal', function(){
        const listEl = document.getElementById('systemsModalList');
        const filterEl = document.getElementById('systemsModalFilter');
        if (!listEl || !filterEl) return;
        const all = (sysState.systems || []).filter(s => String(s.visible)==='true');
        const render = (q='')=>{
            const qq = (q||'').trim().toLowerCase();
            listEl.innerHTML = '';
            all.forEach(async s => {
                const label = s.fullname || s.name || '';
                if (qq && !label.toLowerCase().includes(qq)) return;
                const item = document.createElement('a');
                item.className = 'list-group-item list-group-item-action';
                // Fetch game count lazily
                let count = '';
                try {
                    const res = await fetch(`/systems/${s.name}/games`);
                    const arr = await res.json();
                    const nb = (arr||[]).filter(g => String(g.hidden)!=='true').length;
                    count = ` <span class=\"badge badge-secondary\">${nb}</span>`;
                } catch {}
                item.innerHTML = `
                    ${s.logo ? `<img class=\"sys-logo\" src=\"${s.logo}\" alt=\"\">` : ''}
                    <div class=\"sys-text\">${label}${count}</div>
                `;
                item.addEventListener('click', function(){
                    $('#systemsModal').modal('hide');
                    sysState.selected = s.name;
                    sysState.recent = [s.name, ...sysState.recent.filter(n=>n!==s.name)].slice(0,24);
                    gamesState.page = 1; saveGames(); saveSys();
                    loadGames(s.name);
                    renderSystemDock(true);
                });
                listEl.appendChild(item);
            });
        };
        render('');
        filterEl.value = sysState.filter || '';
        filterEl.oninput = (e)=> render(e.target.value);
    });

    // Open modal from bottom toolbar button
    const sysPickerBtn = document.getElementById('sys-picker-open');
    if (sysPickerBtn) sysPickerBtn.addEventListener('click', ()=> $('#systemsModal').modal('show'));
});

</script>

<!-- Modal windows -->
<div class="modal fade" id="killModal" tabindex="-1" role="dialog" aria-labelledby="KillModalLabel" aria-hidden="true">
<div class="modal-dialog" role="document">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="KillModalLabel">Are you sure?</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">√ó</span></button>
</div>
<div class="modal-body">
Confirm you want to kill the running emulator and game.
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button> <input type="button" class="btn btn-danger" data-dismiss="modal" onclick="emuKill()" value="Kill it!">
</div>
</div>
</div>
</div>

<!-- Systems picker modal -->
<div class="modal fade" id="systemsModal" tabindex="-1" role="dialog" aria-labelledby="systemsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down" role="document" style="max-width: 720px; width: 95%;">
            <div class="modal-content" style="background:#0f172a; color:#e5e7eb;">
            <div class="modal-header">
                <h5 class="modal-title" id="systemsModalLabel">Syst√®mes</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">√ó</span></button>
            </div>
            <div class="modal-body p-2">
                <input id="systemsModalFilter" type="search" class="form-control form-control-sm mb-2" placeholder="Filtrer‚Ä¶">
                <div id="systemsModalList" class="list-group"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
        <style>
            @media (min-width: 769px){ #systemsModal .modal-dialog { height: 85vh; } #systemsModal .modal-content { height: 100%; } #systemsModal .modal-body { overflow-y:auto; } }
            @media (max-width: 768px){ #systemsModal .modal-dialog { margin:0; max-width:100%; width:100%; height:100%; } #systemsModal .modal-content{ height:100%; border-radius:0; } }
            #systemsModalList .list-group-item{ display:flex; align-items:center; gap:10px; cursor:pointer; background:#111827; color:#e5e7eb; border-color: rgba(255,255,255,.08); }
            #systemsModalList .list-group-item:hover{ background:#1f2937; }
            #systemsModalList .sys-logo{ width:56px; height:40px; object-fit:contain; }
            #systemsModalList .sys-text{ flex:1 1 auto; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        </style>
</div>

<div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
<div class="modal-dialog" role="document">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="detailModalLabel"></h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">√ó</span></button>
</div>
<div class="modal-body">
<img class="card-img-top card-img-250" loading="lazy" src="" id="detailModalImg">
<div class="card-body">
<p class="card-text" id="detailModalBody"></p>
<div id="detailFacts" class="detail-facts"></div>
</div>
</div>
<div class="modal-footer">
<input type="button" class="btn btn-primary" id="detailPlayBtn" value="Play" style="display:none">
<input type="button" class="btn btn-danger" id="detailKillBtn" value="Kill" style="display:none">
<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
</div>
</div>
</div>
</div>

<!-- navbars -->
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <div class="w-100">
        <div class="d-flex align-items-center justify-content-between">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="logo-tri.png" height="28">
                <span id="navSystemTitle" class="ml-2 text-light small"></span>
            </a>
            <div class="d-flex align-items-center">
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#topNav" aria-controls="topNav" aria-expanded="false" aria-label="Menu">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <button type="button" class="btn btn-outline-light ml-2" id="toggleToolbar" title="Afficher/Masquer la barre de recherche/tri">
                    <i class="fa fa-search" aria-hidden="true"></i>
                    <i class="fa fa-filter" aria-hidden="true" style="margin-left:6px"></i>
                    <span class="sr-only">Afficher/Masquer la barre de recherche et de tri</span>
                </button>
            </div>
        </div>
            <div class="collapse navbar-collapse mt-2" id="topNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><input type="button" class="btn btn-primary" data-toggle="collapse" data-target="#systemList" aria-expanded="true" aria-controls="systemList" id="showSystems" value="Systems"></li>
                    <li class="nav-item"><button type="button" class="btn btn-secondary" data-toggle="collapse" data-target="#jumbo" id="showNotifs">Current</button></li>
                    <li class="nav-item"><button type="button" class="btn btn-outline-info" id="bwe-random-top" title="Lancer un jeu al√©atoire (filtr√©)"><i class="fa fa-random" aria-hidden="true"></i> Random</button></li>
                    <li class="nav-item"><input type="button" class="btn btn-info" value="Reload" onclick='reloadGamelists()'></li>
                    <li class="nav-item"><button type="button" class="btn btn-danger" data-toggle="modal" data-target="#killModal">Kill</button></li>
                </ul>
            </div>
            <div class="d-flex align-items-center mt-2">
                <div class="container-fluid collapse show currentborder" id="jumbo"></div>
            </div>
    </div>
</nav>

<div class="main-content">
<div class="row">
<div id="gameList"></div>
</div>
</div>

<nav class="navbar navbar-expand navbar-dark bg-dark fixed-bottom">
<div class="mx-auto">
<div class="bottom-bar" id="bottom-bar">
    <span class="summary" id="bottom-summary">0 jeux ¬∑ 0-0</span>
    <div class="pager" id="bottom-pager"></div>
    <select id="bottom-page-size" class="custom-select custom-select-sm" title="Nombre de jeux par page">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="9999">Tous</option>
    </select>
    </div>
<div id="systemList" class="collapse show"></div>
</div>
</nav>

</body>
</html>
